<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Control Panel - Ce Spun Românii</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <style>
      /* Forțează landscape pe mobil */
      @media screen and (orientation: portrait) {
        body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: #000;
          z-index: 9999;
        }
        body::after {
          content: "Vă rugăm rotiți dispozitivul în mod landscape.";
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: #fff;
          font-size: 1.25rem;
          z-index: 10000;
        }
        #main {
          display: none !important;
        }
      }
      .btn-answer.selected {
        background-color: rgba(72, 187, 120, 0.7);
      }
      .btn-pointable {
        cursor: pointer;
      }
      /* Modale */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 50;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white"
  >
    <div
      id="main"
      class="container mx-auto p-4 flex flex-col h-screen justify-between"
    >
      <!-- Ecran inițial -->
      <div
        id="initScreen"
        class="flex flex-col items-center justify-center flex-grow space-y-6"
      >
        <div
          id="gameCodeDisplay"
          class="text-6xl font-extrabold tracking-widest"
        >
          ----
        </div>
        <button
          id="startBtn"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:-translate-y-1"
        >
          <i class="fas fa-play mr-2"></i>START JOC
        </button>
      </div>
      <!-- Control Panel -->
      <div
        id="controlPanel"
        class="hidden flex flex-col flex-grow justify-between"
      >
        <!-- Bara superioară cu echipe -->
        <div class="flex justify-between items-center py-4">
          <!-- Stânga: Echipa 1 -->
          <div class="flex flex-col items-center">
            <div id="team1Name" class="text-xl font-semibold">ECHIPA 1</div>
            <div
              id="team1Total"
              class="mt-2 bg-black/30 px-4 py-2 rounded-lg text-3xl font-bold"
            >
              0
            </div>
          </div>
          <!-- Centru: Puncte Întrebare -->
          <div class="flex flex-col items-center">
            <div class="text-lg">Puncte Întrebare</div>
            <div
              id="questionPoints"
              class="btn-pointable mt-2 bg-black/30 px-6 py-2 rounded-lg text-4xl font-extrabold"
            >
              0
            </div>
          </div>
          <!-- Dreapta: Echipa 2 -->
          <div class="flex flex-col items-center">
            <div id="team2Name" class="text-xl font-semibold">ECHIPA 2</div>
            <div
              id="team2Total"
              class="mt-2 bg-black/30 px-4 py-2 rounded-lg text-3xl font-bold"
            >
              0
            </div>
          </div>
        </div>
        <!-- Întrebare și răspunsuri -->
        <div class="flex-grow overflow-auto">
          <div id="currentQuestion" class="mb-4 text-2xl font-bold text-center">
            Încărcare...
          </div>
          <div id="answersGrid" class="grid grid-cols-2 gap-4"></div>
        </div>
        <!-- Navigare și X-uri -->
        <div class="flex justify-between items-center py-4">
          <button
            id="singleX"
            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold"
          >
            X
          </button>
          <div class="space-x-4">
            <button
              id="prevQ"
              class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold"
            >
              <i class="fas fa-arrow-left mr-1"></i>PREV
            </button>
            <button
              id="nextQ"
              class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold"
            >
              NEXT<i class="fas fa-arrow-right ml-1"></i>
            </button>
          </div>
          <div class="flex space-x-2">
            <button
              data-count="1"
              class="progressiveX bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold"
            >
              X
            </button>
            <button
              data-count="2"
              class="progressiveX bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold"
            >
              XX
            </button>
            <button
              data-count="3"
              class="progressiveX bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold"
            >
              XXX
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal alocare puncte -->
    <div id="assignModal" class="modal flex">
      <div
        class="bg-white rounded-2xl p-6 max-w-sm w-full text-center text-black"
      >
        <h2 class="text-xl font-bold mb-4">Alege echipa</h2>
        <p class="mb-6">
          La ce echipă adaugi cele <span id="modalPoints">0</span> puncte?
        </p>
        <div class="flex justify-around">
          <button
            id="assignTeam1"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold"
          >
            ECHIPA
          </button>
          <button
            id="assignTeam2"
            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold"
          >
            ECHIPA
          </button>
        </div>
      </div>
    </div>
    <!-- Modal următoare întrebare -->
    <div id="nextModal" class="modal flex">
      <div
        class="bg-white rounded-2xl p-6 max-w-sm w-full text-center text-black"
      >
        <h2 class="text-xl font-bold mb-4">Următoarea întrebare</h2>
        <p class="mb-6">Se trece la următoarea întrebare acum.</p>
        <button
          id="nextModalOk"
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold"
        >
          Continuă
        </button>
      </div>
    </div>
    <script>
      const supabaseClient = supabase.createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_ANON_KEY
      );
      const gameCode = new URLSearchParams(window.location.search).get("game");
      const initScreen = document.getElementById("initScreen");
      const controlPanel = document.getElementById("controlPanel");
      const codeDisplay = document.getElementById("gameCodeDisplay");
      const startBtn = document.getElementById("startBtn");
      const team1Name = document.getElementById("team1Name");
      const team2Name = document.getElementById("team2Name");
      const team1Total = document.getElementById("team1Total");
      const team2Total = document.getElementById("team2Total");
      const questionPoints = document.getElementById("questionPoints");
      const currentQuestionElem = document.getElementById("currentQuestion");
      const answersGrid = document.getElementById("answersGrid");
      const prevQ = document.getElementById("prevQ");
      const nextQ = document.getElementById("nextQ");
      const singleX = document.getElementById("singleX");
      const progressiveXBtns = document.querySelectorAll(".progressiveX");
      const assignModal = document.getElementById("assignModal");
      const modalPoints = document.getElementById("modalPoints");
      const assignTeam1 = document.getElementById("assignTeam1");
      const assignTeam2 = document.getElementById("assignTeam2");
      const nextModal = document.getElementById("nextModal");
      const nextModalOk = document.getElementById("nextModalOk");

      let questions = [],
        currentIndex = 0,
        currentQPoints = 0;

      document.addEventListener("DOMContentLoaded", () => {
        codeDisplay.textContent = gameCode || "----";
        startBtn.addEventListener("click", startGame);
        questionPoints.addEventListener("click", showAssignModal);
        assignTeam1.addEventListener("click", () => submitPoints("team1"));
        assignTeam2.addEventListener("click", () => submitPoints("team2"));
        nextModalOk.addEventListener("click", () => {
          nextModal.style.display = "none";
          changeQuestion(currentIndex + 1);
        });
      });

      async function startGame() {
        const { data: game } = await supabaseClient
          .from("games")
          .select("id,set_id,team1_name,team2_name")
          .eq("game_code", gameCode)
          .single();
        team1Name.textContent = game.team1_name;
        team2Name.textContent = game.team2_name;
        assignTeam1.textContent = game.team1_name;
        assignTeam2.textContent = game.team2_name;
        team1Total.textContent = "0";
        team2Total.textContent = "0";
        const { data: items } = await supabaseClient
          .from("question_set_items")
          .select(
            "order_index,questions(id,text,answers(id,text,points,position))"
          )
          .eq("set_id", game.set_id)
          .order("order_index", { ascending: true });
        questions = items.map((item) => item.questions || {});
        initScreen.classList.add("hidden");
        controlPanel.classList.remove("hidden");
        prevQ.addEventListener("click", () => changeQuestion(currentIndex - 1));
        nextQ.addEventListener("click", () => changeQuestion(currentIndex + 1));
        singleX.addEventListener("click", () => sendStrike("X"));
        progressiveXBtns.forEach((btn) =>
          btn.addEventListener("click", () =>
            sendStrike(btn.dataset.count + "X")
          )
        );
        loadQuestion(0);
      }

      function loadQuestion(idx) {
        if (idx < 0 || idx >= questions.length) return;
        currentIndex = idx;
        currentQPoints = 0;
        questionPoints.textContent = "0";
        const q = questions[idx];
        currentQuestionElem.textContent = q.text || "...";

        // 2 coloane: 1-4 sus stânga, 5-8 sus dreapta
        const slots = Array(8).fill(null);
        q.answers.forEach((a) => {
          if (a.position >= 1 && a.position <= 8) slots[a.position - 1] = a;
        });

        answersGrid.innerHTML = "";
        // stânga
        const leftCol = document.createElement("div");
        leftCol.className = "flex flex-col space-y-4";
        slots.slice(0, 4).forEach((a, i) => {
          const btn = document.createElement("button");
          btn.className =
            "btn-answer bg-black/30 p-4 rounded-lg flex justify-between";
          if (a) {
            btn.innerHTML = `<span>${i + 1}. ${a.text}</span><span>${
              a.points
            }</span>`;
            btn.addEventListener("click", () => toggleAnswer(btn, a.points));
          } else {
            btn.innerHTML = `<span>${i + 1}.</span><span></span>`;
            btn.disabled = true;
            btn.classList.add("opacity-50");
          }
          leftCol.append(btn);
        });
        // dreapta
        const rightCol = document.createElement("div");
        rightCol.className = "flex flex-col space-y-4";
        slots.slice(4, 8).forEach((a, i) => {
          const idx = i + 5;
          const btn = document.createElement("button");
          btn.className =
            "btn-answer bg-black/30 p-4 rounded-lg flex justify-between";
          if (a) {
            btn.innerHTML = `<span>${idx}. ${a.text}</span><span>${a.points}</span>`;
            btn.addEventListener("click", () => toggleAnswer(btn, a.points));
          } else {
            btn.innerHTML = `<span>${idx}.</span><span></span>`;
            btn.disabled = true;
            btn.classList.add("opacity-50");
          }
          rightCol.append(btn);
        });
        answersGrid.append(leftCol, rightCol);
      }

      function toggleAnswer(btn, pts) {
        const sel = btn.classList.toggle("selected");
        currentQPoints += sel ? pts : -pts;
        questionPoints.textContent = currentQPoints;
      }

      function showAssignModal() {
        if (currentQPoints === 0) return;
        modalPoints.textContent = currentQPoints;
        assignModal.style.display = "flex";
      }

      function submitPoints(team) {
        if (team === "team1")
          team1Total.textContent =
            parseInt(team1Total.textContent) + currentQPoints;
        else
          team2Total.textContent =
            parseInt(team2Total.textContent) + currentQPoints;
        assignModal.style.display = "none";
        nextModal.style.display = "flex";
      }

      function changeQuestion(newIdx) {
        if (newIdx < 0 || newIdx >= questions.length) return;
        loadQuestion(newIdx);
      }

      function sendStrike(sym) {
        console.log("Strike:", sym);
      }
    </script>
  </body>
</html>
